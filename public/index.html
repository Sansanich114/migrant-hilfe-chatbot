<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Migrant Hilfe Chatbot</title>

  <!-- Montserrat: multiple weights -->
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- CSS -->
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body class="theme-transition">
  <!-- Top Navigation Bar -->
  <nav class="top-nav">
    <div class="nav-left">
      <!-- Toggle Sidebar on left side -->
      <button id="toggleSidebarBtn" class="nav-btn" title="Toggle Sidebar">
        <img src="images/icons/menu.svg" alt="Toggle Sidebar" class="icon" />
      </button>

      <img
        src="images/accent-icons/migrant-logo-accent.svg"
        alt="Migrant Hilfe Logo"
        class="nav-logo"
      />
      <span class="nav-title">Migrant Hilfe</span>
    </div>
    <div class="nav-right">
      <!-- Theme Switch -->
      <button id="themeSwitcher" class="nav-btn theme-btn" title="Toggle Theme">
        <img src="images/icons/theme.svg" alt="Theme Icon" class="theme-icon" />
      </button>

      <!-- Settings -->
      <button id="settingsBtn" class="nav-btn settings-btn" title="Settings">
        <!-- Cleaner icon for settings -->
        <img src="images/icons/settings.svg" alt="Settings" class="icon" />
      </button>

      <!-- Profile -->
      <button id="profileBtn" class="nav-btn profile-btn" title="Profile">
        <!-- Cleaner icon for user -->
        <img src="images/icons/user.svg" alt="User Avatar" class="profile-icon" />
      </button>

      <div id="settingsMenu" class="settings-menu hidden">
        <ul>
          <li id="openAboutUs">About Us</li>
          <li id="deleteAllDataBtn">Delete All Data</li>
          <li id="logoutBtn">Logout</li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <button id="newChatBtn" class="new-chat-btn glow-effect">
        <img
          src="images/accent-icons/new-chat-accent.svg"
          alt="New Chat"
          style="width: 20px; height: 20px; margin-right: 8px;"
        />
        + New Chat
      </button>
      <div id="chatList" class="chat-list">
        <!-- Conversation items go here -->
      </div>
    </aside>

    <!-- Chat Section -->
    <section class="chat-section">
      <!-- Chat Container -->
      <div class="chat-container" id="chatContainer">
        <!-- Messages appended here dynamically -->
      </div>

      <!-- Suggestions Row -->
      <div class="suggestions" id="suggestions">
        <!-- Suggestion pills rendered dynamically -->
      </div>

      <!-- Input Bar -->
      <div class="input-bar">
        <textarea
          id="chatInput"
          placeholder="Type a message..."
        ></textarea>
        <button id="sendBtn" class="send-btn glow-effect">
          <!-- Make arrow white via filter or use a white icon -->
          <img src="images/accent-icons/send-accent.svg" alt="Send" />
        </button>
      </div>
    </section>
  </div>

  <!-- About Us Modal -->
  <div id="aboutModal" class="modal hidden">
    <div class="modal-content">
      <span id="closeAbout" class="modal-close">&times;</span>
      <h2>About Us</h2>
      <p>Our mission is to help migrants integrate into Germany with ease. 
         We offer free guidance, resources, and personalized support.</p>
      <p><strong>Team Members:</strong> Coming soon...</p>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal hidden">
    <div class="modal-content">
      <span id="closeProfile" class="modal-close">&times;</span>
      <h2>Your Profile</h2>
      <div class="profile-field">
        <label>Username:</label>
        <span id="profileUsername">Anonymous</span>
      </div>
      <div class="profile-field">
        <label>Email:</label>
        <span id="profileEmail">No email set</span>
      </div>
      <div class="profile-field">
        <label>Subscription:</label>
        <span id="profileSubscription">Free Plan</span>
      </div>
      <div class="profile-actions">
        <button id="logoutProfileBtn" class="glow-effect danger logout-btn">Logout</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Detect browser language and store it
    const userLanguage = navigator.language || 'en';
    localStorage.setItem("userLanguage", userLanguage);
  
    /**************************************************************
     * GLOBAL SELECTORS / DOM ELEMENTS
     **************************************************************/
    const body = document.body;
    const themeSwitcher = document.getElementById("themeSwitcher");
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsMenu = document.getElementById("settingsMenu");
    const aboutModal = document.getElementById("aboutModal");
    const closeAbout = document.getElementById("closeAbout");
    const openAboutUs = document.getElementById("openAboutUs");
    const profileBtn = document.getElementById("profileBtn");
    const profileModal = document.getElementById("profileModal");
    const closeProfile = document.getElementById("closeProfile");
  
    const toggleSidebarBtn = document.getElementById("toggleSidebarBtn");

    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatContainer = document.getElementById("chatContainer");
    const suggestionsDiv = document.getElementById("suggestions");
    const chatListDiv = document.getElementById("chatList");

    const deleteAllDataBtn = document.getElementById("deleteAllDataBtn");
  
    let isBotTyping = false; // flag to prevent sending new message while bot is processing
  
    /**************************************************************
     * EVENT LISTENERS
     **************************************************************/
    // Toggle sidebar
    toggleSidebarBtn.addEventListener("click", () => {
      body.classList.toggle("sidebar-hidden");
    });

    // Theme toggle
    themeSwitcher.addEventListener("click", () => {
      body.classList.toggle("dark-mode");
      settingsMenu.classList.add("hidden");
    });

    // Settings dropdown
    settingsBtn.addEventListener("click", () => {
      settingsMenu.classList.toggle("hidden");
    });

    // About Us modal
    openAboutUs.addEventListener("click", () => {
      aboutModal.classList.remove("hidden");
      settingsMenu.classList.add("hidden");
    });
    closeAbout.addEventListener("click", () => {
      aboutModal.classList.add("hidden");
    });

    // Profile modal
    profileBtn.addEventListener("click", () => {
      profileModal.classList.remove("hidden");
    });
    closeProfile.addEventListener("click", () => {
      profileModal.classList.add("hidden");
    });

    // Delete all user data
    deleteAllDataBtn.addEventListener("click", () => {
      settingsMenu.classList.add("hidden");
      deleteAllUserData();
    });

    // Close modals when clicking outside
    window.addEventListener("click", (e) => {
      if (e.target === aboutModal) aboutModal.classList.add("hidden");
      if (e.target === profileModal) profileModal.classList.add("hidden");
    });
  
    // New Chat - creates a new conversation and updates chat list
    const newChatBtn = document.getElementById("newChatBtn");
    newChatBtn.addEventListener("click", () => {
      createNewConversation();
    });
  
    // Send message on button or Enter
    sendBtn.addEventListener("click", sendMessage);
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  
    // Adjust textarea height as user types
    chatInput.addEventListener("input", () => autoResize(chatInput));
  
    /**************************************************************
     * INIT: CREATE PROFILE IF NOT EXIST, THEN INTRO + CONVERSATIONS
     **************************************************************/
    if (!localStorage.getItem("userId")) {
      createProfile();
    } else {
      fetchIntro();
      fetchConversations();
    }
  
    /**************************************************************
     * MAIN FUNCTIONS
     **************************************************************/
    function createProfile() {
      const language = localStorage.getItem("userLanguage") || "en";
      fetch("/createProfile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ profileInfo: { language: language } }),
      })
        .then((res) => res.json())
        .then((data) => {
          localStorage.setItem("userId", data.userId);
          localStorage.setItem("conversationId", data.conversationId);
          fetchIntro();
          fetchConversations();
        })
        .catch((err) => console.error("Error creating profile:", err));
    }

    function fetchIntro() {
      const userId = localStorage.getItem("userId");
      const language = localStorage.getItem("userLanguage") || "en";
      if (!userId) return;
  
      fetch(`/intro?userId=${userId}&lang=${language}`)
        .then((res) => res.json())
        .then((data) => {
          if (data.reply) {
            addMessage("bot", data.reply);
          }
          updateSuggestions(data.suggestions || []);
        })
        .catch((err) => console.error("Error fetching intro message:", err));
    }

    function fetchConversations() {
      const userId = localStorage.getItem("userId");
      if (!userId) return;
      fetch(`/profile/${userId}`)
        .then((res) => res.json())
        .then((data) => {
          if (data.conversations) {
            chatListDiv.innerHTML = "";
            data.conversations.forEach((conv) => {
              const convItem = document.createElement("div");
              convItem.className = "chat-item";

              // Left part (conversation name)
              const convName = document.createElement("span");
              convName.innerText = conv.conversationName || "Conversation " + conv._id.slice(-4);
              convItem.appendChild(convName);

              // Right part (buttons)
              const btnContainer = document.createElement("div");
              btnContainer.style.display = "flex";
              btnContainer.style.gap = "8px";

              // Edit button
              const editBtn = document.createElement("button");
              editBtn.className = "edit-btn";
              editBtn.innerText = "✏️";
              editBtn.onclick = async (e) => {
                e.stopPropagation(); // prevent loading conversation
                const newName = prompt("Enter a new name for this conversation:", conv.conversationName);
                if (!newName) return;
                try {
                  await fetch("/renameConversation", {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ conversationId: conv._id, newName })
                  });
                  fetchConversations(); // Refresh
                } catch (err) {
                  console.error("Rename failed:", err);
                }
              };

              // Delete button
              const deleteBtn = document.createElement("button");
              deleteBtn.innerText = "🗑️";
              deleteBtn.onclick = async (e) => {
                e.stopPropagation(); // prevent loading conversation
                if (!confirm("Are you sure you want to delete this conversation?")) return;
                try {
                  await fetch("/deleteConversation", {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ conversationId: conv._id })
                  });
                  fetchConversations();
                } catch (err) {
                  console.error("Delete failed:", err);
                }
              };

              btnContainer.appendChild(editBtn);
              btnContainer.appendChild(deleteBtn);
              convItem.appendChild(btnContainer);

              // Load conversation on click
              convItem.onclick = () => loadConversation(conv._id);
  
              chatListDiv.appendChild(convItem);
            });
          }
        })
        .catch((err) => console.error("Error fetching conversations:", err));
    }

    function loadConversation(conversationId) {
      const userId = localStorage.getItem("userId");
      if (!userId) return;
      fetch(`/profile/${userId}`)
        .then((res) => res.json())
        .then((data) => {
          const conv = data.conversations.find(c => c._id === conversationId);
          if (conv) {
            localStorage.setItem("conversationId", conversationId);
            chatContainer.innerHTML = "";
            conv.messages.forEach((msg) => {
              // system messages we treat as bot
              if (msg.role === "assistant" || msg.role === "system") {
                addMessage("bot", msg.content);
              } else {
                addMessage("user", msg.content);
              }
            });
          }
        })
        .catch((err) => console.error("Error loading conversation:", err));
    }

    async function deleteAllUserData() {
      const userId = localStorage.getItem("userId");
      if (!userId) return;
      if (!confirm("Are you sure you want to delete ALL data? This cannot be undone.")) return;
      try {
        await fetch("/deleteAllUserData", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId })
        });
        // Clear localStorage except for language
        const lang = localStorage.getItem("userLanguage");
        localStorage.clear();
        localStorage.setItem("userLanguage", lang);

        // Reload page or do a new profile
        window.location.reload();
      } catch (err) {
        console.error("Error deleting all user data:", err);
        alert("Unable to delete data.");
      }
    }

    /**************************************************************
     * MESSAGE HANDLING
     **************************************************************/
    function sendMessage() {
      if (isBotTyping) return; // prevent sending if bot is processing
      const userMessage = chatInput.value.trim();
      if (!userMessage) return;
      addMessage("user", userMessage);
      chatInput.value = "";
      autoResize(chatInput);
      disableInput(true);
      addBotTypingMessage();
  
      const userId = localStorage.getItem("userId");
      const conversationId = localStorage.getItem("conversationId");
      const payload = { userId, conversationId, message: userMessage };
  
      fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then((response) => response.json())
        .then((data) => {
          removeBotTypingMessage();
          disableInput(false);
          if (data.reply) {
            addMessage("bot", data.reply);
          } else {
            addMessage("bot", "Sorry, I didn't get a response.");
          }
          updateSuggestions(data.suggestions);
        })
        .catch((error) => {
          removeBotTypingMessage();
          disableInput(false);
          console.error("Error in /chat:", error);
          addMessage("bot", "Error: Unable to process request.");
        });
    }

    function disableInput(disable) {
      chatInput.disabled = disable;
      sendBtn.disabled = disable;
    }

    function addMessage(sender, text) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", sender);
  
      const bubbleDiv = document.createElement("div");
      bubbleDiv.className = "bubble";
      bubbleDiv.innerText = text;
  
      if (sender === "user") {
        const userAvatarImg = document.createElement("img");
        userAvatarImg.classList.add("avatar");
        userAvatarImg.src = "images/accent-icons/user-accent.svg";
        userAvatarImg.alt = "User Avatar";
        messageDiv.appendChild(userAvatarImg);
        messageDiv.appendChild(bubbleDiv);
      } else {
        const botAvatar = document.createElement("img");
        botAvatar.className = "avatar";
        botAvatar.src = "images/accent-icons/bot-accent.svg";
        botAvatar.alt = "Bot Avatar";
        messageDiv.appendChild(botAvatar);
        messageDiv.appendChild(bubbleDiv);
      }
  
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
  
    let typingIndicatorElement = null;
  
    function addBotTypingMessage() {
      isBotTyping = true;
      typingIndicatorElement = document.createElement("div");
      typingIndicatorElement.classList.add("message", "bot", "typing-message");
  
      const botAvatar = document.createElement("img");
      botAvatar.className = "avatar";
      botAvatar.src = "images/accent-icons/bot-accent.svg";
      botAvatar.alt = "Bot Avatar";
      typingIndicatorElement.appendChild(botAvatar);
  
      const bubbleDiv = document.createElement("div");
      bubbleDiv.className = "bubble";
      bubbleDiv.innerHTML = '<div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
      typingIndicatorElement.appendChild(bubbleDiv);
  
      chatContainer.appendChild(typingIndicatorElement);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
  
    function removeBotTypingMessage() {
      if (typingIndicatorElement) {
        chatContainer.removeChild(typingIndicatorElement);
        typingIndicatorElement = null;
        isBotTyping = false;
      }
    }
  
    function updateSuggestions(suggestions) {
      suggestionsDiv.innerHTML = "";
      if (suggestions && suggestions.length > 0) {
        suggestions.forEach((suggestion) => {
          const suggestionBtn = document.createElement("div");
          suggestionBtn.className = "suggestion bubble-lift";
          suggestionBtn.innerText = suggestion;
          suggestionBtn.onclick = () => {
            chatInput.value = suggestion;
            autoResize(chatInput);
          };
          suggestionsDiv.appendChild(suggestionBtn);
        });
      }
    }
  
    function autoResize(textarea) {
      textarea.style.height = "auto";
      textarea.style.height = textarea.scrollHeight + "px";
    }
  </script>
</body>
</html>
